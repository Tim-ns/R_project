---
title: "Project"
output: html_document
date: "2025-05-15"
---

```{r}
library(readr,tidytuesdayR)
```

```         
```

```         
```

```{r}
historical_spending <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2024/2024-02-13/historical_spending.csv', show_col_types = FALSE)
gifts_age <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2024/2024-02-13/gifts_age.csv', show_col_types = FALSE)
gifts_gender <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2024/2024-02-13/gifts_gender.csv', show_col_types = FALSE)

```

```{r}
historical_spending
```

```{r}
gifts_age
```

```{r}
gifts_gender
```

# EDA

```{r}
library(tidyverse)
library(lubridate)
library(scales)
library(skimr)
library(patchwork)
library(ggrepel)
library(dplyr)
library(tidyr)
```

```{r}
glimpse(historical_spending)
```

```{r}
skim(historical_spending)
```

```{r}
skim(gifts_age)
```

```{r}
skim(gifts_gender)
```

```{r}
sum(is.na(gifts_age)) 
```

```{r}
sum(is.na(historical_spending))
```

```{r}
gift_gender_wide <- gifts_gender %>% 
  pivot_wider(
    names_from = Gender,
    values_from = Gender
  )
gift_gender_wide
```

```{r}
gifts_gender
```

## Dataset's extention

## historical_spending

### Compute total average spending per year (AnnualSpending_tot)

```{r}
historical_spending_ext <- historical_spending %>% 
  mutate(AnnualSpending_tot = rowSums(.[,4:ncol(.)]))

historical_spending_ext
```

### Compute change in PerPerson spending year-over-year (SpendingChange)

```{r}
historical_spending_ext <- historical_spending_ext %>%
  arrange(Year) %>% 
  mutate(SpendingChange = case_when(
           row_number() == 1 ~ "0%",
           !is.na(PerPerson) & !is.na(lag(PerPerson)) ~ {
             change <- (PerPerson - lag(PerPerson)) / lag(PerPerson)
             ifelse(change > 0, paste0("+", round(change * 100, 2), "%"),
             paste0(round(change * 100,2), "%"))
            },
           TRUE ~ NA_character_
         )
         )

historical_spending_ext
```

### Find category with the highest spending over the year (HighestSpending)

```{r}
historical_spending_ext <- historical_spending_ext %>% 
  mutate(
    SpendingCols = across(Candy:GiftCards),
    HighestSpending = names(SpendingCols)[max.col(SpendingCols, ties.method = "first")],
    SpendingCols = NULL
  )
historical_spending_ext
```

## gifts_age

### Convert Age to categorical (Age_cat)

```{r}
gifts_age_cat <- gifts_age %>% 
  mutate(
    Age_cat = case_when(
      Age == "18-24" ~ 1,
      Age == "25-34" ~ 2,
      Age == "35-44" ~ 3,
      Age == "45-54" ~ 4,
      Age == "55-64" ~ 5,
      Age == "65+" ~ 6,
      TRUE ~ NA_integer_
    ),
    .after = Age
  )
print(gifts_age_cat)
```

### Find category with the highest spending by each group (HighestSpending)

```{r}
gifts_age_ext <- gifts_age_cat %>% 
  mutate(
    SpendingCols = across(Candy:GiftCards),
    HighestSpending = names(SpendingCols)[max.col(SpendingCols, ties.method = "first")],
    SpendingCols = NULL
  )
gifts_age_ext
```

### Compute Affinity index between Age and average spending on each category (Affinity\_ ). An Affinity index \>100 indicate that the target group is more likely to purchase some products compare to the average across all age groups

```{r}
overall_cat_relevance <- gifts_age_ext %>% 
  summarise(across(Candy:GiftCards, ~ mean(.x, na.rm=TRUE))) %>% 
  pivot_longer(cols=everything(), names_to = "Category", values_to = "OverallRelevance")

gifts_age_affinity <- gifts_age_ext %>% 
  pivot_longer(cols = Candy:GiftCards, names_to = "Category", values_to = "AgeGroupRelevance") %>% 
  left_join(overall_cat_relevance, by="Category") %>% 
  mutate(
    AffinityIndex = ifelse(
      OverallRelevance != 0,
      (AgeGroupRelevance / OverallRelevance) * 100,
      NA_real_
    )
  ) %>% 
  select(Age, Category, AffinityIndex) %>% 
  pivot_wider(names_from =Category, values_from = AffinityIndex, names_prefix = "Affinity_")

gifts_age_ext_wide <- left_join(gifts_age_ext, gifts_age_affinity, by = "Age")

gifts_age_ext_wide
```

## gifts_gender

### Find category with the highest spending by each gender (HighestSpending)

```{r}
gifts_gender_ext <- gifts_gender %>% 
  mutate(
    SpendingCols = across(Candy:GiftCards),
    HighestSpending = names(SpendingCols)[max.col(SpendingCols, ties.method = "first")],
    SpendingCols = NULL
  )
gifts_gender_ext
```

### Compute Affinity index between Gender and average spending on each category (Affinity\_ ). An Affinity index \>100 indicate that the target group is more likely to purchase some products compare to the average across all genders 

```{r}
overall_gender_cat_relevance <- gifts_gender_ext %>% 
  summarise(across(Candy:GiftCards, ~ mean(.x, na.rm=TRUE))) %>% 
  pivot_longer(cols=everything(), names_to = "Category", values_to = "OverallRelevance")

gifts_gender_affinity <- gifts_gender_ext %>% 
  pivot_longer(cols = Candy:GiftCards, names_to = "Category", values_to = "GenderRelevance") %>% 
  left_join(overall_gender_cat_relevance, by="Category") %>% 
  mutate(
    AffinityIndex = ifelse(
      OverallRelevance != 0,
      (GenderRelevance / OverallRelevance) * 100,
      NA_real_
    )
  ) %>% 
  select(Gender, Category, AffinityIndex) %>% 
  pivot_wider(names_from =Category, values_from = AffinityIndex, names_prefix = "Affinity_")

gifts_gender_ext_wide <- left_join(gifts_gender_ext, gifts_gender_affinity, by = "Gender")

gifts_gender_ext_wide
```

```{r}
### Compare gift spending by gender
gifts_gender_long <- gifts_gender_ext %>%
  pivot_longer(cols = -Gender, names_to = "Category", values_to = "Spending")

ggplot(gifts_gender_long, aes(x = Category, y = Spending, fill = Gender)) +
  geom_col(position = "dodge") +
  theme_minimal() +
  labs(
    title = "Gift Spending by Category and Gender",
    y = "Spending",
    x = "Gift Category"
  ) +
  scale_fill_brewer(palette = "Set1")
```
